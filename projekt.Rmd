---
title: "Poročilo pri predmetu Analiza podatkov s programom R"
author: "Veronika Nabergoj"
output:
  html_document: default
  pdf_document:
    includes:
      in_header: lib/styles.sty
    latex_engine: xelatex
runtime: shiny
---

```{r setup, echo=FALSE, results='hide', message=FALSE,warning=FALSE}
# Če želimo nastaviti pisave v PDF-ju, odkomentiramo
# in sledimo navodilom v programu.
#source("fontconfig.r", encoding = "UTF-8")

# Uvoz vseh potrebnih knjižnic
source("lib/libraries.r", encoding = "UTF-8")
```

# Izbira teme

Izbrala sem si temo preseljevanja v Sloveniji. V tem projektu bom raziskala in analizirala priseljevanje in izseljevanje prebivalstva, od leta 1995 do leta 2014, po posameznih regijah Slovenije in po starostnih skupinah. Pregledala bom podatke Slovenije in analizirala v katerih starostnih skupinah in v katerih regiajh je prišlo do porasta preseljevanja. Ločila bom preseljevanje tudi po državljanstvu in tako natančneje določila koliko slovenskih državljanov se je izselilo iz Slovenije ali priselilo nazaj v Slovenijo.

***

# Obdelava, uvoz in čiščenje podatkov

```{r uvoz, echo=FALSE}
source("uvoz/uvoz.r", encoding = "UTF-8")
```

Najprej sem poiskala podatke. Našla sem jih na spletni strani: 

* Statistični urad RS: `http://www.stat.si/StatWeb/pregled-podrocja?idp=17&headerbar=15`


### Tabela 1

Uvozila sem podatke o preseljevanju iz Slovenije ter v Slovenijo v obliki CSV iz splene strani statističnega urada RS. Podatki so ločeni glede na leto, državljanstvo, starostno skupino in spol.

```{r tabela1, echo=FALSE}
kable(head(tabela))
```

V tej tabeli so v zadnjem, šestem stolpcu številske spremenljivke, v preostalih pa so imenske spremenljivke. 

Najprej sem morala tabelo očistiti praznih vrstic, ki jih je uvozilo iz spletne strani, zato sem uporabila sledečo funkcijo:

##### Funkcija za urejanje tabel:
```{r uredimo}
uredimo <- function(tabela, x, y, z, max = nrow(tabela)) {
  s <- seq(x, max, z+1)
  tabela[t(matrix(x:max, ncol=length(s))), y] <- tabela[s, y]
  tabela <- tabela[-s,]
  return(tabela)
}
```

Ta funkcija je tudi zapisala v vsako vrstico tisto imensko spremenljvko, ki bi tam morala biti. 
Nato sem še preverila da so številske spremenljivke zares številke.

Ko je bila tabela urejena in so bili vsi podatki zbrani, sem najprej fitrirala tabelo po prvi spremenljivki: priseljeni iz tujine in odseljeni v tujino in tako dobila dve tabeli: priseljeni in odseljeni.

Da bi nato lažje in učinkoviteje filtrirala tabele po različnih spremenljivkah sem sestavila sledečo funkcijo _razberi_:

##### Funkcija za filtriranje podatkov iz tabel
```{r razberi}
razberi <- function(x,y,podatki){
  return(podatki[podatki[y] == x, names(podatki) != y])
}
```

S to funkcijo sem dobila podtabele po letih, državljanstvu in starostnih skupinah.

### Tabela 1 v tidy data obliki

Tabelo 1 sem pretvorila v tidy data obliko tako, da sem odstranila stolpce skupaj, ki so mi bili v pomoč pri risanju grafov. Dodala sem ji tudi stolpec, v katerem je urejenostna spremenljivka, ki prikaže prirast ljudi (odštejemo odseljene od priseljenih).

```{r tabela1tidy, echo=FALSE}
kable(head(tidytabela1))
```

#### Spremenljivke:

Stolpci v tabeli 1:

* priseljeni.ali.odseljeni: _imenska spremenljivka_
* leto: _številska spremenljivka_
* starostna.skupina: _imenska spremenljivka_
* drzavljanstvo: _imenska spremenljivka_
* spol: _imenska spremenljivka_
* stevilka: _številska spremenljivka_
* priseljeni.minus.odseljeni.prirast: _urejenostna spremenljivka_

### Tabela 2

Kot drugo tabelo sem uvozila še podatke o priseljevanju iz tujine in priseljevanju v tujino po regijah in letih v obliki html.

```{r tabela2, echo=FALSE}
kable(head(tabela2))
```

Tudi tu sem morala najprej prečistiti podatke, izbrisati določene vrstice in nato s funkcijo _uredimo_ pretvorila v želene tabele. 

### Tabela 2 v tidy data obliki

```{r tabela2tidy, echo=FALSE}
kable(head(tidytabela2))
```

#### Spremenljivke:

Stolpci v tabeli 2 imajo sledeče značilnosti:

* regija: _imenska spremenljivka_
* leto: _številska spremenljivka_
* Priseljeni.iz.tujine.moški: _številska spremenljivka_
* Priseljeni.iz.tujine.ženske: _številska spremenljivka_
* Odseljeni.v.tujino.moški: _številska spremenljivka_
* Odseljeni.v.tujino.ženske: _številska spremenljivka_
* Priseljeni.iz.tujine.na.1000.prebivalcev: _številska spremenljivka_
* Odseljeni.v.tujino.na.1000.prebivalcev: _številska spremenljivka_

***

### Graf razlike priseljenih Slovencev in odseljenih Slovencev

Slika \ref{fig:graf} prikazuje razliko med priseljenimi Slovenci in odseljenimi Slovenci po letih in starostnih skupinah (te so prikazane z različnimi barvami) ter prirast (oblika), ki je očiten, saj je lahko pozitiven, negativen ali enak 0.

```{r graf, echo=FALSE, fig.align='center', fig.cap='Graf razlike priseljenih Slovencev in odseljenih Slovencev'}
ggplot(data=priseljeni.minus.odseljeni%>%filter(starostna.skupina !="Starostne skupine - SKUPAJ"),
       aes(x=leto, y=razlika,color=starostna.skupina)) + geom_point(size=6) +
       coord_flip() 
```
 
Iz grafa je razvidno da je največji negativen prirast postajal vedno bolj negativen in je 2014 tudi dosegel največjo stopnjo izseljevanja. Če pogledamo še starostne skupine, padejo v kategorijo **25-29 let** in kategorijo **30-35 let**. 

### Graf odseljenih ali priseljenih prebivalcev ločenih po državljanstvu za izbrano leto


```{r shiny2, echo=FALSE, fig.align='center', fig.cap='Graf odseljenih ali priseljenih prebivalcev ločenih po državljanstvu za izbrano leto'}
shinyAppDir("shiny2", options=list(width="100%", height=590))
```

### Graf za odseljene prebivalce po starostnih skupinah skupaj in državljanstvu skupaj

Tu \ref{fig:graf3} vidimo je bilo odseljevanje najmočnejše leta 2009.

```{r graf3, echo=FALSE, fig.align='center', fig.cap='Graf za odseljene prebivalce po starostnih skupinah skupaj, državljanstvu skupaj in spolu'}
ggplot(data=odseljeni4,
       aes(leto,stevilka,fill=spol))+ geom_bar(stat="identity",size=6) + coord_flip()
```

### Graf za priseljene ali odseljene za izbrano leto po spolu:


```{r shiny, echo=FALSE, fig.align='center', fig.cap='Graf za priseljene ali odseljene za izbrano leto'}
shinyAppDir("shiny", options=list(width="100%", height=475))
```


### Graf za odseljene v tujino za Goriško regijo po letih:

Ta slika \ref{fig:graf5} nam predstavi odseljene prebivalce Goriške regije v letih od 1995-2014. Razvidno je bilo leta 2009 največje odseljevanje. V _Grafu za odseljene prebivalce po starostnih skupinah skupaj in državljanstvu skupaj_ smo prav tako omenili, da je bilo preseljevanje najmočnejše leta 2009.

```{r graf5, echo=FALSE, fig.align='center', fig.cap='Graf za odseljene v tujino za Goriško regijo po letih'}
ggplot(data=Goriska,
       aes(x=leto, y=Odseljeni.v.tujino.skupaj,alpha=Odseljeni.v.tujino.na.1000.prebivalcev)) + 
       geom_point(size=10,color="firebrick3")
```

***

# Analiza in vizualizacija podatkov

```{r ainv, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
source("vizualizacija/vizualizacija.r", encoding = "UTF-8")
```


### Zemljevid regij Slovenije obarvan glede na izbrano kategorijo in v izbranem letu:

```{r shiny3, echo=FALSE, fig.align='center', fig.cap='Zemljevid regij Slovenije obarvan glede na izbrano kategorijo in v izbranem letu:'}
shinyAppDir("shiny3", options=list(width="100%", height=450))
```


### Zemljevid regij Slovenije obarvanih glede na intenzivnost priseljevanje iz tujine leta 2014:

Zemljevid nam prikazuje priseljevanje iz tujine, skupaj po spolu, za leto 2014. Kot je razvidno se največ priseljevanja kot nam je že pokazal graf 5, dogaja v Osrednjeslovenski regiji. S prosojnostjo barv pa je prikazano, koliko je priseljenih iz tujine na 1000 prebivalcev.


S prosojnostjo barv pa je prikazano, koliko je priseljenih iz tujine na 1000 prebivalcev.
 


### Zemljevid regij Slovenije obarvanih glede na intenzivnost odseljevanja v tujino leta 2014:

Zemljevid nam prikazuje odseljevanje v tujino, skupaj po spolu, za leto 2014. Kot je razvidno se največ odseljevanja dogaja v Osrednjeslovenski regiji. 


Tu pa nam je še s prosojnostjo barv je prikazano, koliko je odseljenih v tujino na 1000 prebivalcev.

```{r zemljevid2_2,echo=FALSE, fig.align='center', fig.cap='Zemljevid odseljevanja v tujino leta 2014'}
zem.reg2014.odseljeni2 <- ggplot() + geom_polygon(data = reg14, aes(x=long, y=lat, group=group,
                                                    fill=odseljeni.skupaj,
                                                    alpha=odseljeni.v.tujino.na.1000.prebivalcev),
                                       color = "grey35") +
  scale_fill_gradient(low="aquamarine4", high="aquamarine") +
  guides(fill = guide_colorbar(title = "Odseljeni v tujino v letu 2014"))
print(zem.reg2014.odseljeni2)
```

### Zemljevid regij Slovenije obarvanih glede na prirast leta 2014:

Tu vidimo zemljevi prirasta v letu 2014. Kot je razvidno je najbolj negativen prirast v severnih regijah. 


***

# Napredna analiza

```{r napanaliza, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
source("analiza/analiza.r", encoding = "UTF-8")
```